function doGet(e) {
  Logger.log(JSON.stringify(e));

  const sheetId = '1hCBouE-LxNpzkJbGI-ngq2cECctbfBe3WadpduYn1Ko';
  const sheet   = SpreadsheetApp.openById(sheetId).getActiveSheet();

  // ====== MODO READ (devuelve JSON) ======
  // Llamada ejemplo:
  // .../exec?mode=read&limit=200
  if (e && e.parameter && (e.parameter.mode || "").toLowerCase() === "read") {
    const limit = Math.min(parseInt(e.parameter.limit || "200", 10), 2000); // límite de seguridad
    const lastRow = sheet.getLastRow();
    const startRow = Math.max(1, lastRow - limit + 1);

    // Columnas: A..H (8 cols) = Fecha, maxHum, minHum, maxTemp, minTemp, maxVPD, minVPD, cicloLuz
    const numCols = 8;
    const numRows = Math.max(0, lastRow - startRow + 1);

    const values = (numRows > 0)
      ? sheet.getRange(startRow, 1, numRows, numCols).getValues()
      : [];

    // Convertimos a objetos
    const rows = values.map(r => ({
      fecha: r[0],         // Date
      maxHum: r[1],
      minHum: r[2],
      maxTemp: r[3],
      minTemp: r[4],
      maxVpd: r[5],
      minVpd: r[6],
      cicloLuz: r[7]       // "LUZ"/"OSCURIDAD"
    }));

    const payload = {
      ok: true,
      count: rows.length,
      last: rows.length ? rows[rows.length - 1] : null,
      rows
    };

    return ContentService
      .createTextOutput(JSON.stringify(payload))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // ====== MODO WRITE (tu lógica actual) ======
  let result = 'Ok';

  if (!e || !e.parameter) {
    result = 'No Parameters';
  } else {
    const newRow = sheet.getLastRow() + 1;
    const cicloLuz = e.parameter.cicloLuz || "";

    const rowData = [
      new Date(),
      e.parameter.maxHumidity    || "",
      e.parameter.minHumidity    || "",
      e.parameter.maxTemperature || "",
      e.parameter.minTemperature || "",
      e.parameter.maxVPD         || "",
      e.parameter.minVPD         || "",
      cicloLuz
    ];

    sheet.getRange(newRow, 1, 1, rowData.length).setValues([rowData]);
    result = 'Datos escritos en la hoja de cálculo';
  }

  return ContentService.createTextOutput(result);
}
